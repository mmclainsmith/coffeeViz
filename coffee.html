<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
    body {
        background: #fcfcfa;
    }
    .stroke {
        fill: none;
        stroke: #000;
        stroke-width: 3px;
    }
    .fill {
        fill: #fff;
    }
    .graticule {
        fill: none;
        stroke: #777;
        stroke-width: .5px;
        stroke-opacity: .5;
    }
    .land {
        fill: #222;
    }
    .boundary {
        fill: none;
        stroke: #fff;
        stroke-width: .5px;
    }
    .selected {
        stroke: black;
    }

    .line {
    	fill: none;
    	stroke: blue;
    	stroke-width: 2px;
    }
</style>
</head>

<body>
<svg width="980" height="270" id="main"></svg>
<div id="selected"></div>

<script src="js/d3.v4.min.js"></script>
<script src="js/topojson.v1.min.js"></script>

<script>
    let svg = d3.select("#main"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    let dataByCountry = d3.nest();

    let projection = d3.geoMercator()
                        .scale(200)
                        .translate([ 422, height / 2])
                        .precision(0);

    let path = d3.geoPath().projection(projection);

    let graticule = d3.geoGraticule();

    svg.append("path")
        .datum(graticule)
        .attr("class", "graticule")
        .attr("d", path)

    svg.on("click", function(d){selected = []; updatedSelected(); });


/******************************************************************************
            Reading in data
 *****************************************************************************/
    d3.queue()
        .defer(d3.json, "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
        .defer(d3.csv, "ICO_CROP_DATA.csv", function(d){
            let month_abv = {"April":'apr', "July":'jul', "October":'oct'};
            let data = {};
            data.country = d.COUNTRY;
            data.prod = +d.TOTAL_PRODUCTION;
            data.consum = +d.DOMESTIC_CONSUMPTION;
            data.export = +d.EXPORTABLE_PRODUCTION;
            data.stock = +d.GROSS_OPENING_STOCKS;
            data.year = +d.YEAR.slice(0,4);
            data.month = month_abv[d.MONTH];
            return data
         })
        .await(ready);

/******************************************************************************
            Initializing page
 *****************************************************************************/

    function ready(error, world, data) {
        if (error) throw error;

        dataByCountry = dataByCountry
            .key(function(d) { return d.country; })
            .key(function(d) { return d.year; })
            .object(data);

        // Draw countries
        svg.selectAll(".country")
            .data(world.features)
            .enter().insert("path", ".graticule")
                .attr("class", "country")
                .attr("d", path)
                .style("fill", "lightgrey")
                .classed("clickable", function(d) { return dataByCountry[d.properties.name]; })

        svg.selectAll(".clickable")
                .datum(function(d) { return {'name':d.properties.name, 'data':dataByCountry[d.properties.name] } })
                .style("fill", "grey")
                //.on("click", clickCountrySelect)
                .call(d3.drag()
                    .on("start", startCountrySelect)
                    .on("drag", dragCountrySelect)
                    .on("end", endCountrySelect));


        drawLineChart("Ethiopia");
    };

/*****************************************************************************
                Interactions Handlers
 *****************************************************************************/
    let selected = []
    function updatedSelected() {
     //Update Map
        d3.selectAll('.clickable')
            .classed('selected', function(d) {
                return selected.includes(d.name);
            })
         d3.selectAll('.selected').raise();

     //Update bar
        d3.selectAll("#selected a").remove();
        d3.select("#selected").selectAll("a")
            .data(selected)
            .enter().append("a")
                //.on("click", function)
                .html(function(d){
                     console.log(d);
                     return d;
                })
    }

    function startCountrySelect(d){
        console.log("start");
        d3.select("#main")
            .append("rect");
    }

    function dragCountrySelect(d){
        console.log("dragging");
    }

    function endCountrySelect(d){
        console.log(d3.event)
        console.log("end");
        select([d.name], d3.event.sourceEvent.shiftKey);
    }

    function clickCountrySelect(d) {
        console.log(d3.event)
        select([d.name], d3.event.sourceEvent.shiftKey);
    }

    function select(nameList, shift) {
        for (let i = 0; i < nameList.length; i++) {
            if (shift) {
                console.log('shirt')
                console.log(nameList[i])
                console.log(nameList[i])
                console.log(selected)
                index = selected.indexOf(nameList[i]);
                if (index == -1) { //Id not in list
                    selected.push(nameList[i]);
                } else {
                    selected.splice(index);
                }
            } else {
                selected = nameList
            }
        }
        updatedSelected()
    }
/*****************************************************************************
                Chart Makers
 *****************************************************************************/

    // Note example drawLineChart above - it needs to be run in the function ready()
    function drawLineChart(countryName) {
    	// Ref: https://bl.ocks.org/d3noob/4db972df5d7efc7d611255d1cc6f3c4f
        let data = dataByCountry[countryName];
        console.log(data);
        console.log(data[1990][0]); //Get data from 1990
        console.log(data[1990][0].month); //see month of that data
        console.log(data[1990][0].consum); //see consumption in that year
        console.log(data[1990][0].year); //see consumption in that year
        
        // dimensions of graph
        var margin = {top: 20, right: 20, bottom: 30, left: 50},
        	width = 960 - margin.left - margin.right,
        	height = 500 - margin.top - margin.bottom;
        // axis ranges
        var x = d3.scaleLinear().domain([1990, 2017]).range([0, width]);
        var y = d3.scaleLinear().domain([0, 2000]).range([height, 0]); //TODO: replace 200 with max consum value

        // consumption line
        var annualconsum = function(year) {
        	var line = d3.line()
        				.x(function(d) {return x(year); })
        				.y(function(d) {return y(data[year][0].consum); });
        	return line;
        }

        //append svg
        var svg = d3.select("body").append("svg")
        	.attr("width", width + margin.left + margin.right)
        	.attr("height", 1000) //height + margin.top + margin.bottom)
        .append("g")
        	.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        //loop through years
    	for (let i = 1990; i < 2018; i++) {
        	var consumline = annualconsum(i);
	        svg.append("path")
	        	.data([data])
	        	.attr("class", "line")
	        	.attr("d", consumline);
	        }
        /*
        for (let i = 1990; i < 2018; i++) {
        	var consumline = d3.line()
	        	.x(function(d) {return x(i); })
	        	.y(function(d) {return y(data[i][0].consum); });
        }
        */

        // add the X Axis
		  svg.append("g")
		      .attr("transform", "translate(0," + height + ")")
		      .call(d3.axisBottom(x));
		// add the Y Axis
		  svg.append("g")
		      .call(d3.axisLeft(y));
    }

</script>
</body>
</html>
