<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
    @import url('https://fonts.googleapis.com/css?family=Caveat');
    @import url('https://fonts.googleapis.com/css?family=Mali');

    :root {
      --darkest-brown: #4F2D0D;
      --dark-brown: #7E685A;
      --light-brown: #C2B9B0;
      --light-green: #fcfcf6;
      --green: #839153;
      --b-grey: #C2CAD0;
      --grey: gainsboro;
      --time: .5s;
    }

    body {
        background: var(--light-green);
        text-align: center;
        margin: 0;
    }

    h1 {
        font-family: 'Mali';
        font-size: 64pt;
        color: var(--darkest-brown);
        margin: 0;
    }

    h2, h3 {
        font-family: sans-serif;
        margin: 2px;
    }
    h2 {
        font-weight: 300;
    }
    h3 {
        color: var(--green);
        font-weight: lighter;
    }

    svg {
        margin: 0 auto;
        display: block;
    }

    div {
        transition: var(--time);
    }

    .graticule {
        fill: none;
        stroke: var(--darkest-brown);
        stroke-width: .5px;
        stroke-opacity: .5;
        stroke-dasharray: 1,1;
    }

    .graticule, .domain, .tick {
        shape-rendering: crispEdges;
    }
    .country {
        stroke: var(--darkest-brown);
        stroke-width: .5px;
        stroke-opacity: .5;
        stroke-dasharray: 2,2;
        transition: var(--time) fill;
    }
    .coffee {
        stroke-dasharray: 1,0;
    }
    .unclickable {
        stroke-dasharray: 2,2;
        fill: var(--grey) !important;
    }

    .selected {
        stroke: black;
        stroke-width: 1px;
        stroke-opacity: 1;
    }

    .line {
    	fill: none;
    	stroke: black;
    	stroke-width: 2px;
    }

    .Cline { /* consumption */
        fill: none;
        stroke: brown;
        stroke-width: 2px;
    }
    .Pline { /* production */
        fill: none;
        stroke: green;
        stroke-width: 2px;
    }
    .Eline { /* export */
        fill: none;
        stroke: blue;
        stroke-width: 2px;
    }

    .bar {
    	fill: var(--dark-brown);
    }

    #main {
        background: var(--b-grey);
    }

    .slideBar {
        fill: var(--grey);
    }

    .monthFilterButton{
        display: inline-block;
        margin: 3px;
        padding: 5px;
        background-color: var(--light-brown);
        text-align: center;
        width: 5em;
        color: var(--dark-brown);
    }

    .down {
        background-color: var(--dark-brown);
        color: black;
    }

    .sliderBrush .selection {
        fill: var(--green);
        fill-opacity: 0.6;
        stroke: none;
    }

    .sliderBrush .handle--e, .sliderBrush .handle--w {
        fill: var(--dark-brown);
    }

    .sliderBrush .selection:active {
        cursor: grabbing;
    }

    #sliderAxis text {
        fill: var(--darkest-brown);
    }

    #sliderLines .tick line,  #sliderAxis .tick line {
        stroke: var(--dark-brown) !important;
        stroke-dasharray: 1,1;
        opacity: 0.7;
    }

    #sliderLines .domain, #sliderAxis .domain{
        stroke: none !important;
    }

</style>
</head>

<body>
<h1> Coffee </h1>
<h2> A look at coffee production around the world </h2>
<h3> Lexie Kirsch and Morgan McLain-Smith </h3>
<div class ="monthFilterButton down" id="apr"> April </div>
<div class ="monthFilterButton down" id="jul"> July </div>
<div class ="monthFilterButton down" id="oct"> October </div>
<svg width="980" height="270" id="main"></svg>

<svg id="slider"></svg>
<div id="selected"></div>
<svg id="lower"></svg>


<script src="js/d3.v4.min.js"></script>
<script src="js/topojson.v1.min.js"></script>

<script>
    let svg = d3.select("#main"),
        width = +svg.attr("width"),
        height = +svg.attr("height");

    // This is horrifying, forgive me Mark.
    let startYear = 1990,
        endYear = 2018,
        cStat   = 'prod';

    let dataByCountry = d3.nest();

    let projection = d3.geoMercator()
                        .scale(200)
                        .translate([ 422, height / 2])
                        .precision(0);

    let path = d3.geoPath().projection(projection);

    let graticule = d3.geoGraticule().step([5, 5]);

    d3.selectAll(".monthFilterButton")
        .on("click", function(d) {
            btn = d3.select(this)
            btn.classed('down', function(d){
                return !d3.select(this).classed("down");
            });
            filterByMonth(btn.attr('id'))
        });

    svg.append("path")
        .datum(graticule)
        .attr("class", "graticule")
        .attr("d", path);

    svg.on("click", function(d){selected = []; updatedSelected(); });


/******************************************************************************
            Reading in data
 *****************************************************************************/
    d3.queue()
        .defer(d3.json, "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json")
        .defer(d3.csv, "ICO_CROP_DATA.csv", function(d){
            let month_abv = {"April":'apr', "July":'jul', "October":'oct'}
            let data = {};
            data.country = d.COUNTRY;
            data.prod = +d.TOTAL_PRODUCTION;
            data.consum = +d.DOMESTIC_CONSUMPTION;
            data.export = +d.EXPORTABLE_PRODUCTION;
            data.stock = +d.GROSS_OPENING_STOCKS;
            data.year = +d.YEAR.slice(0,4);
            data.month = month_abv[d.MONTH];
            return data
         })
        .await(ready);

/******************************************************************************
            Initializing page
 *****************************************************************************/

    function ready(error, world, data) {
        if (error) throw error;


        dataByCountry = dataByCountry
            .key(function(d) { return d.country; })
            .object(data);

        makeSlider()

        // Draw countries
        svg.append('g')
            .selectAll(".country")
            .data(world.features)
            .enter().insert("path", ".graticule")
                .attr("class", "country")
                .attr("d", path)
                .classed("coffee", function(d) { return dataByCountry[d.properties.name]; })
                .classed("unclickable", function(d) { return !dataByCountry[d.properties.name]; })
                .transition().duration(6000);

        svg.selectAll(".coffee")
                .datum(function(d) { return {'name':d.properties.name, 'data':dataByCountry[d.properties.name] } })
                //.on("click", clickCountrySelect)
                .call(d3.drag()
                    .on("start", startCountrySelect)
                    .on("drag", dragCountrySelect)
                    .on("end", endCountrySelect));


        colorMap();
    };

/*****************************************************************************
                Interactions Handlers
 *****************************************************************************/
    let selected = []
    function updatedSelected() {
        // Remove unclickable things from selected
        svg.selectAll('.coffee.unclickable')
            .each(function(d) {
                if (selected.includes(d.name)) {
                    selected.splice( selected.indexOf(d.name) );
                }
            })
            .classed('selected', false)

        if (selected.length == 1) {
            drawLineChart(selected[0]);
            // drawBarChart(selected[0]);
        }

        if (selected.length > 1) { // TODO: add multiple selections
        	drawBarChart(selected[0])
        }
     //Update Map
        d3.selectAll('.coffee:not(.unclickable)')
            .classed('selected', function(d) {
                return selected.includes(d.name);
            })
         d3.selectAll('.selected').raise();

     //Update bar
        d3.selectAll("#selected a").remove();
        d3.select("#selected").selectAll("a")
            .data(selected)
            .enter().append("a")
                //.on("click", function)
                .html(function(d){
                     return d;
                })
    }

    function startCountrySelect(d){
        //console.log("start");
        d3.select("#main")
            .append("rect");
    }

    function dragCountrySelect(d){
        //console.log("dragging");
    }

    function endCountrySelect(d){

        console.log("end");
        select([d.name], d3.event.sourceEvent.shiftKey);
    }

    function clickCountrySelect(d) {
        d3.event.stopPropagation(); // Allows background clicking to deselect
        select([d.name], d3.event.sourceEvent.shiftKey);
    }

    function select(nameList, shift) {
        for (let i = 0; i < nameList.length; i++) {
            if (shift) {
                console.log('shirt')
                console.log(nameList[i])
                console.log(nameList[i])
                index = selected.indexOf(nameList[i]);
                if (index == -1) { //Id not in list
                    selected.push(nameList[i]);
                } else {
                    selected.splice(index);
                }
            } else {
                selected = nameList
            }
        }
        console.log(selected)
        updatedSelected()
    }


/*****************************  Month Filters ********************************/

    function filterByMonth(month){
        svg.selectAll('.coffee')
            .classed('unclickable', function(d){
                let matchesMonth = d.data[0].month == month;
                if (!matchesMonth) { //Other month, stay the same
                    return d3.select(this).classed('unclickable')
                } else { // specified month, toggle
                    return !d3.select(this).classed('unclickable')
                }
            });
        updatedSelected();
        colorMap();
    }

/*******************************  Color Map **********************************/
    let mapColors = d3.scaleLinear().range(['#C2B9B0', '#4F2D0D']);


    function colorMap(){
        let sums = {};
        svg.selectAll('.coffee:not(.unclickable)')
            .each(d => {
                sums[d.name] = d3.nest()
                    .rollup( d2 => d3.sum(d2, d3 => d3[cStat]))
                    .object( d.data.filter( d2 => (startYear <= d2.year && d2.year < endYear) ))
                }
            );
        let sumsArr = Object.values(sums);
        let colors = mapColors.domain([d3.min(sumsArr), d3.max(sumsArr)])

        svg.selectAll('.coffee')
            .style('fill', d => colors(sums[d.name]) );
    }

/*****************************************************************************
                Chart Makers
 *****************************************************************************/

    function drawLineChart(countryName) {
        // Ref: https://bl.ocks.org/d3noob/4db972df5d7efc7d611255d1cc6f3c4f
        let data = dataByCountry[countryName];

        // dimensions of graph
        let margin = {top: 20, right: 20, bottom: 30, left: 60},
                      width = 960 - margin.left - margin.right,
                      height = 500 - margin.top - margin.bottom;

        // axis ranges
        let max = d3.nest()
                    .rollup(d => {return [
                        d3.max(d, d2 => d2["prod"]),
                        d3.max(d, d2 => d2["consum"]),
                        d3.max(d, d2 => d2["export"]),
                    ]})
                    .object(data)


        let x = d3.scaleLinear().domain([1990, 2017]).range([0, width]);
        let y = d3.scaleLinear().domain([0, d3.max(max)]).range([height, 0]); //TODO: scale domain height to max value

        // lines
        let consumptionLine = d3.line()
            .x(function(d) { return x(d.year); })
            .y(function(d) { return y(d.consum); });

        let productionLine = d3.line()
        	.x(function(d) { return x(d.year); })
        	.y(function(d) { return y(d.prod); });

        let exportLine = d3.line()
        	.x(function(d) { return x(d.year); })
        	.y(function(d) { return y(d.export); });

        // append svg
        let svg2 = d3.select("#lower")
        svg2.selectAll("*").remove()

        let graph = svg2.attr("width", width + margin.left + margin.right)
            .attr("height", 1000)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // add the lines!
        for (let i = 0; i < 3; i++) {
        	var linetype = ["Cline", "Pline", "Eline"];
        	var line = [consumptionLine, productionLine, exportLine];
        	graph.append("path")
	            .data([data])
	            .attr("class", linetype[i])
	            .attr("d", line[i]);
        }

        // add X axis
        graph.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x).tickFormat(d3.format("d")));

        // label X axis
        graph.append("text")
        	.attr("transform", "translate(" + (width/2) + "," + (height + margin.top + 20) + ")")
        	.style("text-anchor", "middle")
        	.text("Year");

        // add Y axis
        graph.append("g")
            .call(d3.axisLeft(y));

        // label Y axis
        graph.append("text")
        	.attr("transform", "rotate(-90)")
        	.attr("y", 0 - margin.left)
        	.attr("x", 0 - (height / 2))
        	.attr("dy", "1em")
        	.style("text-anchor", "middle")
        	.text("Thousand 60kg bags of green coffee");

        // add legend
        for (let i = 0; i < 3; i++) {
        	var linetypes = ["Consumption", "Export", "Production"];
        	var colors = ["brown", "blue", "green"];
        	graph.append('rect')
				.attr("transform", "translate(" + (width/2 - (100*(i-1))) + "," + (height + margin.top + 50) + ")")
				.attr('width', 20)
				.attr('height', 20)
				.attr('fill', colors[i]);
			graph.append("text")
	        	.attr("transform", "translate(" + (width/2 - (100*(i-1)) + 10) + "," + (height + margin.top + 85) + ")")
	        	.style("text-anchor", "middle")
	        	.text(linetypes[i]);
        }

        return

        // TODO: get rid of commas in the year
    }

    function drawBarChart(countryName) {
        let data = dataByCountry[countryName];

        // dimensions of graph
        let margin = {top: 20, right: 20, bottom: 30, left: 60},
                      width = 960 - margin.left - margin.right,
                      height = 500 - margin.top - margin.bottom;
        // axis ranges
        let x = d3.scaleBand().domain([0, 10]).range([0, width]); //TODO: change domain to number of countries
        let y = d3.scaleLinear().domain([0, d3.max(data, function(d) { return d.prod; })]).range([height, 0]);

        let svg2 = d3.select("#lower")
        svg2.selectAll("*").remove()

        svg2.append("text")
        	.attr("transform", "translate(" + (width/2) + "," + (margin.top) + ")")
        	.style("text-anchor", "middle")
        	.text("Production in 2017");

        svg2.selectAll(".bar").data([data])
        	.enter().append("rect")
        		.attr("class", "bar")
        		.attr("x", function(d) { return x(0); })
        		.attr("width", 50)
        		.attr("y", function(d) { return y(d[27].prod); })
        		.attr("height", function(d) { return height - y(d[27].prod); });

        let graph = svg2.attr("width", width + margin.left + margin.right)
            .attr("height", 1000)
            .append("g")
            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        // add X axis
        graph.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x));

        graph.append("text")
        	.attr("transform", "translate(" + (width/2) + "," + (height + margin.top + 20) + ")")
        	.style("text-anchor", "middle")
        	.text("Country");

        // add Y axis
        graph.append("g")
            .call(d3.axisLeft(y));

        graph.append("text")
        	.attr("transform", "rotate(-90)")
        	.attr("y", 0 - margin.left)
        	.attr("x", 0 - (height / 2))
        	.attr("dy", "1em")
        	.style("text-anchor", "middle")
        	.text("Production per thousand 60kg bags of green coffee");
    }



/*****************************************************************************
                Time Slider
 *****************************************************************************/
    function makeSlider() {
        let slider = {  svg: d3.select('#slider'),
                        height: 70,
                        mTop: 20,
                        mLeft: 20 }

        let yearScale = d3.scaleLinear()
                            .domain([1990, 2018])
                            .range([0, width - 1]);

        // Allowed sliding area
        slider.svg.attr('width', width + 2 * slider.mLeft)
            .attr('height', slider.height)
            .append('rect')
                .attr('class', 'slideBar')
                .attr('width', width)
                .attr('height', slider.height - slider.mTop * 2)
                .attr("transform", `translate(${slider.mLeft}, ${slider.mTop})`);

        //Numbered tick marks
        slider.svg.append('g')
            .attr("id", "sliderAxis")
            .attr("transform", `translate(${slider.mLeft}, ${slider.height - slider.mTop})`)
            .call(d3.axisBottom(yearScale)
                    .tickSize(10)
                    .tickFormat(d3.format("d")));

        // Unlabelled ticks
        slider.svg.append('g')
            .attr("id", 'sliderLines')
            .attr("transform", `translate(${slider.mLeft}, ${slider.mTop})`)
            .call(d3.axisBottom(yearScale)
                    .tickSize(slider.height - slider.mTop * 2)
                    .ticks(20)
                    .tickFormat(function() { return null; })
                );

        let sliderBrush = d3.brushX()
                .extent([[yearScale.range()[0], 0],
                         [yearScale.range()[1], slider.height - 2 * slider.mTop]])
                .on("end", sliderBrushEnded)
                .on("brush", sliderBrushing);

        slider.svg.append("g")
            .attr("class", "sliderBrush")
            .attr("transform", `translate(${slider.mLeft}, ${slider.mTop})`)
            .call(sliderBrush)
            .call(sliderBrush.move, [startYear, endYear].map(yearScale));


        function sliderBrushEnded() {
            if (!d3.event.sourceEvent) return; // Only transition after input.
            if (!d3.event.selection) return; // Ignore empty selections.
            var d0 = d3.event.selection.map(yearScale.invert),
                d1 = d0.map(Math.round);

            d3.select(this).transition().call(d3.event.target.move, d1.map(yearScale));

            startYear = d1[0];
            endYear = d1[1];
            colorMap();
        }

        function sliderBrushing() {
            //console.log( d3.event );
        }
    }

</script>
</body>
</html>
